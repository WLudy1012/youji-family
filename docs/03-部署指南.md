# 由基家族网站系统 - 部署指南

## 一、环境要求

### 服务器配置建议
- **CPU**: 2核+
- **内存**: 4GB+
- **硬盘**: 50GB+
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **网络**: 公网IP，开放80/443端口

### 软件依赖
- Docker 20.10+
- Docker Compose 2.0+
- Git (可选)

## 二、快速部署（Docker方式）

### 1. 安装 Docker

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# CentOS
sudo yum install -y docker
docker --version
docker-compose --version
```

### 2. 克隆/上传代码

```bash
# 方式1：Git克隆（如果有Git仓库）
git clone <你的仓库地址> youji-family
cd youji-family

# 方式2：直接上传文件
# 使用SFTP/SCP将代码上传到服务器
```

### 3. 配置环境变量

```bash
cd youji-family/docker

# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件
nano .env
```

**.env 文件示例：**

```env
# 数据库配置
DB_ROOT_PASSWORD=your_root_password
DB_NAME=youji_family
DB_USER=youji
DB_PASSWORD=your_secure_password
DB_PORT=3306

# JWT配置
JWT_SECRET=your_super_secret_jwt_key_change_this
JWT_EXPIRES_IN=7d

# 端口配置
HTTP_PORT=80
HTTPS_PORT=443
BACKEND_PORT=8080
```

### 4. 启动服务

```bash
# 构建并启动
docker-compose up -d --build

# 查看日志
docker-compose logs -f

# 查看状态
docker-compose ps
```

### 5. 初始化数据库

数据库会在首次启动时自动初始化，执行 `sql/init.sql` 中的脚本。

默认管理员账号：
- 用户名: `admin`
- 密码: `admin123`

**⚠️ 重要：首次登录后请立即修改默认密码！**

### 6. 访问网站

- 前台网站: `http://你的服务器IP/`
- 管理后台: `http://你的服务器IP/admin`

## 三、域名和SSL配置

### 1. 域名解析

在你的域名服务商处添加A记录：
```
@    A    你的服务器IP
www  A    你的服务器IP
```

### 2. 申请SSL证书（使用Certbot）

```bash
# 安装Certbot
docker run -it --rm \
  -v "$(pwd)/ssl:/etc/letsencrypt" \
  -v "$(pwd)/docker/nginx.conf:/etc/nginx/nginx.conf:ro" \
  certbot/certbot certonly --standalone -d your-domain.com

# 自动续期（添加到crontab）
0 0 * * * docker run --rm -v "$(pwd)/ssl:/etc/letsencrypt" certbot/certbot renew
```

### 3. 修改Nginx配置启用HTTPS

编辑 `docker/nginx.conf`，添加HTTPS server块：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/nginx/ssl/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/your-domain.com/privkey.pem;

    # ... 其他配置与HTTP相同
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 4. 重启Nginx

```bash
docker-compose restart nginx
```

## 四、裸机部署（不使用Docker）

### 1. 安装依赖

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y nodejs npm mysql-server nginx

# CentOS
sudo yum install -y nodejs npm mysql-server nginx
```

### 2. 配置MySQL

```bash
# 启动MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 创建数据库和用户
sudo mysql -u root -p

CREATE DATABASE youji_family CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'youji'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON youji_family.* TO 'youji'@'localhost';
FLUSH PRIVILEGES;
EXIT;

# 导入初始化脚本
mysql -u youji -p youji_family < sql/init.sql
```

### 3. 部署后端

```bash
cd backend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
nano .env

# 启动服务（生产环境建议使用PM2）
npm install -g pm2
pm2 start src/app.js --name youji-backend
pm2 save
pm2 startup
```

### 4. 部署前端

```bash
cd frontend

# 安装依赖
npm install

# 构建
npm run build

# 复制到Nginx目录
sudo cp -r dist/* /var/www/html/
```

### 5. 部署管理后台

```bash
cd admin

# 安装依赖
npm install

# 构建
npm run build

# 复制到Nginx目录
sudo mkdir -p /var/www/html/admin
sudo cp -r dist/* /var/www/html/admin/
```

### 6. 配置Nginx

```bash
sudo nano /etc/nginx/sites-available/youji-family
```

添加配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /admin {
        alias /var/www/html/admin;
        try_files $uri $uri/ /admin/index.html;
    }

    location /api {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /uploads {
        alias /var/www/html/uploads;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/youji-family /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

## 五、数据备份与恢复

### 自动备份脚本

创建备份脚本 `backup.sh`：

```bash
#!/bin/bash

BACKUP_DIR="/backups/youji-family"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="youji_family"
DB_USER="youji"
DB_PASS="your_password"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
docker exec youji-mysql mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/db_$DATE.sql

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz uploads/

# 保留最近7天的备份
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete

echo "备份完成: $DATE"
```

添加到定时任务：

```bash
chmod +x backup.sh

# 每天凌晨2点执行备份
crontab -e
0 2 * * * /path/to/backup.sh >> /var/log/youji-backup.log 2>&1
```

### 数据恢复

```bash
# 恢复数据库
docker exec -i youji-mysql mysql -uyouji -pyour_password youji_family < backup.sql

# 恢复上传文件
tar -xzf uploads_backup.tar.gz
```

## 六、常见问题

### 1. 数据库连接失败

检查：
- MySQL容器是否正常运行：`docker-compose ps`
- 环境变量配置是否正确
- 数据库用户权限是否正确

### 2. 文件上传失败

检查：
- 上传目录权限：`chmod -R 777 uploads/`
- Nginx配置中的上传大小限制

### 3. 跨域问题

后端已配置CORS，如仍有问题，检查：
- 前端请求的API地址是否正确
- 环境变量中的域名配置

### 4. 前端页面空白

检查：
- 是否正确构建：`npm run build`
- Nginx配置中的try_files是否正确

## 七、更新部署

```bash
# 拉取最新代码
git pull

# 重新构建并重启
docker-compose down
docker-compose up -d --build

# 如果需要更新数据库结构
docker exec -i youji-mysql mysql -uyouji -pyour_password youji_family < sql/update.sql
```

## 八、安全建议

1. **修改默认密码**：首次登录后立即修改admin密码
2. **使用强密码**：数据库密码、JWT密钥使用随机生成的强密码
3. **定期更新**：定期更新系统和依赖包
4. **防火墙配置**：只开放必要的端口（80, 443, 22）
5. **日志监控**：定期检查日志文件，发现异常及时处理
